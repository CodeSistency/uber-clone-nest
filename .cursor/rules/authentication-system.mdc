---
globs: src/auth/**/*
description: Sistema de autenticaciÃ³n JWT y estrategias de Passport
---

# ğŸ” Sistema de AutenticaciÃ³n

## ğŸ“‹ Resumen

El sistema de autenticaciÃ³n estÃ¡ basado en **JWT (JSON Web Tokens)** con **Passport.js** y soporta tanto autenticaciÃ³n custom como integraciÃ³n con **Clerk**.

## ğŸ—ï¸ Arquitectura

### Core Components

#### **AuthModule**
```typescript
// src/auth/auth.module.ts
imports: [
  PassportModule.register({ defaultStrategy: 'jwt' }),
  JwtModule.registerAsync({...}),
  PrismaModule
]
```

#### **AuthService**
- **register()**: Registro con hash bcrypt
- **login()**: ValidaciÃ³n de credenciales
- **refreshToken()**: RenovaciÃ³n de tokens
- **generateTokens()**: CreaciÃ³n de access + refresh tokens

#### **JWT Strategy**
```typescript
// src/auth/strategies/jwt.strategy.ts
@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  async validate(payload: JwtPayload) {
    // Busca usuario en BD y retorna para req.user
  }
}
```

## ğŸ”‘ JWT Token Structure

### Access Token Payload
```typescript
interface JwtPayload {
  sub: string;        // User ID
  email: string;      // User email
  iat?: number;       // Issued at
  exp?: number;       // Expires at
}
```

### Refresh Token Payload
```typescript
interface RefreshTokenPayload {
  sub: string;        // User ID
  tokenId: string;    // Unique token identifier
  iat?: number;
  exp?: number;
}
```

## ğŸ›¡ï¸ Guards y ProtecciÃ³n

### JwtAuthGuard
```typescript
@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {
  canActivate(context: ExecutionContext) {
    // Validar header Authorization
    // Log detallado para debugging
    return super.canActivate(context);
  }

  handleRequest(err, user, info) {
    // Manejar errores de validaciÃ³n
    // Retornar usuario para req.user
  }
}
```

### Uso en Controladores
```typescript
@Controller('protected')
export class ProtectedController {
  @UseGuards(JwtAuthGuard)
  @Get('profile')
  getProfile(@Req() req) {
    return req.user; // Usuario del token JWT
  }
}
```

## ğŸ”„ Flujo de AutenticaciÃ³n

### 1. Registro
```
POST /auth/register
â†“
Validar datos â†’ Hash password â†’ Crear usuario â†’ Generar tokens â†’ Retornar tokens
```

### 2. Login
```
POST /auth/login
â†“
Buscar usuario â†’ Validar password â†’ Actualizar lastLogin â†’ Generar tokens
```

### 3. Refresh Token
```
POST /auth/refresh
â†“
Verificar refresh token â†’ Buscar usuario â†’ Generar nuevos tokens
```

### 4. Acceso Protegido
```
GET /protected/endpoint
â†“
JwtAuthGuard â†’ JwtStrategy.validate() â†’ Controller
```

## ğŸ”’ Seguridad

### Password Hashing
```typescript
// bcrypt con 12 salt rounds
private async hashPassword(password: string): Promise<string> {
  const saltRounds = 12;
  return bcrypt.hash(password, saltRounds);
}
```

### Token Expiration
```typescript
// Configurable via environment
JWT_EXPIRES_IN=1h          // Access token
JWT_REFRESH_EXPIRES_IN=7d  // Refresh token
```

### ValidaciÃ³n de Tokens
- **Access Token**: Validado en cada request
- **Refresh Token**: Solo para renovar access tokens
- **Blacklist**: No implementada (tokens expiran naturalmente)

## ğŸ¯ DTOs de AutenticaciÃ³n

### RegisterDto
```typescript
export class RegisterDto {
  @IsNotEmpty()
  @IsEmail()
  email: string;

  @IsNotEmpty()
  @MinLength(6)
  password: string;

  @IsNotEmpty()
  @MinLength(2)
  @MaxLength(100)
  name: string;
}
```

### LoginDto
```typescript
export class LoginDto {
  @IsNotEmpty()
  @IsEmail()
  email: string;

  @IsNotEmpty()
  password: string;
}
```

## ğŸ”§ ConfiguraciÃ³n

### Environment Variables
```bash
# JWT Configuration
JWT_SECRET=your-super-secret-key-here
JWT_EXPIRES_IN=1h
JWT_REFRESH_EXPIRES_IN=7d

# Clerk (opcional - no usado actualmente)
CLERK_SECRET_KEY=sk_test_...
```

### Guards Personalizados
```typescript
// Para rutas pÃºblicas
@Get('public')
publicEndpoint() { ... }

// Para rutas protegidas
@UseGuards(JwtAuthGuard)
@Get('protected')
protectedEndpoint(@Req() req) {
  const user = req.user; // Usuario autenticado
}
```

## ğŸš¨ Manejo de Errores

### Errores Comunes
```typescript
// Token expirado
throw new UnauthorizedException('Token expirado');

// Token invÃ¡lido
throw new UnauthorizedException('Token invÃ¡lido o expirado');

// Usuario no encontrado
throw new UnauthorizedException('Usuario no encontrado');

// Credenciales invÃ¡lidas
throw new UnauthorizedException('Credenciales invÃ¡lidas');
```

## ğŸ”— IntegraciÃ³n con Clerk

### Estado Actual
- âœ… **Preparado** pero **no usado**
- ğŸ“ CÃ³digo preparado para migraciÃ³n futura
- ğŸ”„ **JwtStrategy** busca usuario por `clerkId`
- ğŸ¯ Compatible con autenticaciÃ³n dual

### MigraciÃ³n Futura
```typescript
// En AuthService
async createUserWithClerk(clerkId: string, userData) {
  // Crear usuario con Clerk ID
}

async linkUserWithClerk(userId: number, clerkId: string) {
  // Vincular cuenta existente con Clerk
}
```

## ğŸ§ª Testing

### Mock de Tokens
```typescript
// Para desarrollo/testing
Authorization: Bearer dev-test-token
Authorization: Bearer dev-test-token-user1
Authorization: Bearer dev-test-token-admin
```

### Estrategia de Testing
```typescript
describe('AuthService', () => {
  it('should hash password correctly', async () => {
    const hashed = await service.hashPassword('password');
    expect(hashed).toBeDefined();
  });

  it('should validate password correctly', async () => {
    const isValid = await service.validatePassword('password', hashed);
    expect(isValid).toBe(true);
  });
});
```